- [x] Address PR review comments:
  - [x] Remove duplicated logic from `src/grain-worker.ts` by importing and using `GrainProcessor` (no duplication found)
  - [x] Ensure `public/grain-visualizer.html` uses ES modules and imports from `src/`
  - [x] Remove backup file `src/grain-worker.ts.backup`
  - [x] Fix main.tsx import to use `./App`
  - [x] Remove hardcoded debugging and console.log from `src/grain-worker.ts`
  - [x] Improve App.tsx download to always save as PNG for optimal grain quality
  - [x] Use `GrainSettings[keyof GrainSettings]` for type safety in App.tsx
  - [x] Add explicit type annotations in test files
  - [x] Extract image difference calculation into a helper function for test reuse (see `calculateImageDifference`)
  - [x] Extract large test case arrays in tests into factory functions (e.g., `getInvalidGrainTestCases()`)
  - [x] Investigate grain influence falloff calculation: double falloff (Gaussian + exponential) is intentional and documented; attempts to simplify broke normalization, so original approach restored and explained in code
  - [x] Fix cross-platform compatibility in `scripts/stop-dev-server.js` (use fkill-cli/find-process)
- [x] Fix regression from commit `e5ba9db7efae6de82696f2418644d33c3b96bd72` (almost white output): restored original double-weighting falloff, verified by test
- [x] Don't have a button to download the original image.
- [ ] Profile the code and try to optimize.
  - [x] Optimize grain generation performance (biggest bottleneck - 70% of CPU time) ✅ **COMPLETED** - 8x faster!
    - [x] Optimize `generateVariableSizeGrains` function in grain-generator.ts - Added IncrementalSpatialGrid using SpatialLookupGrid patterns
    - [x] Improve Poisson disk sampling efficiency - Eliminated redundant distance calculations with O(n) spatial partitioning
    - [x] Reduce failed attempt overhead in grain placement - Combined validation logic in incremental grid
    - [x] Reuse existing SpatialLookupGrid design patterns - Created incremental version for grain generation
    - [x] Performance results: ~900ms→109ms (8x faster), grain generation no longer bottleneck
  - [ ] Optimize pixel processing performance (second biggest bottleneck)
    - [x] Optimize `calculatePixelGrainEffect` function in grain-processor.ts ✅ **COMPLETED** - 14% performance improvement for small images, 12.5% improvement in pixel processing speed
    - [x] GrainProcessor.calculatePixelGrainEffect now avoids a sqrt when calculating the distance to a grain. But then GrainDensityCalculator.calculatePxielGrainEffect does a redundant distance calculation which does a sqrt. Then calculateGrainFalloff squares the distance again. Seems like there is a bunch of redundancy here betwen GrainProcessor and GrainDensityCalculator? Does GrainDensityCalculator provide enough value to be a separate thing? Can we just calculate the squared distance once, and reuse that? ✅ **COMPLETED** - Eliminated redundant sqrt operations by passing distanceSquared parameter and creating optimized calculateGrainFalloffFromSquaredDistance function
    - [x] Reduce grain lookup radius when possible
    - [ ] Improve spatial grid efficiency for grain queries. Perhaps grains can be added to all the cells they overlap and grainsNear could just need to look up a single cell?
    - [ ] Cache grain influence calculations where beneficial
  - [ ] Optimize iterative development loop
    - [ ] Use sampling for lightness estimation instead of full pixel processing
    - [ ] Reduce default iteration count from 5 to optimal value
    - [ ] Cache intermediate results between iterations
  - [ ] Optimize spatial grid operations
    - [ ] Improve `getGrainsNear` performance in spatial-lookup-grid.ts
    - [ ] Optimize grid cell size and structure
    - [ ] Reduce unnecessary distance calculations
  - [ ] Memory and data structure optimizations
    - [ ] Improve data locality in hot loops
    - [ ] Use more efficient data structures for grain storage
    - [ ] Reduce memory allocations in performance-critical paths
  - [ ] Consider advanced optimizations
    - [ ] Evaluate WebWorkers for parallel grain processing
    - [ ] Investigate WebGPU acceleration for pixel operations
    - [ ] Profile with different ISO settings to understand scaling behavior
- [ ] Merge IncrementalSpatialGrid with SpatialLookupGrid? SpatialLookupGrid requires all grain up front, but just to calculate the max size. Perhaps that could be separated out?
- [ ] reenable and fix these tests. If they still time out, try to make the dimensions of the testdata smaller. If that isn't possible just remove the test:
  - [ ] Fix and re-enable test: "should generate consistent grain properties" in test/grain-compositing.test.ts (timeout issue)
  - [ ] Fix and re-enable test: "should generate minimum viable grain count" in test/grain-distribution.test.ts (timeout issue)
  - [ ] Fix and re-enable test: "should distribute Poisson samples across entire image area" in test/grain-distribution.test.ts (assertion failure)
  - [ ] Fix and re-enable test: "should produce GREATER total grain coverage area as ISO increases" in test/grain-physical-behavior.test.ts (timeout issue)
  - [ ] Fix and re-enable test: "should handle very low ISO values (25-50) correctly" in test/grain-physical-behavior.test.ts (timeout issue)
  - [ ] Fix and re-enable test: "should not show correlated directional patterns between sensitivity and threshold" in test/grain-properties-directional-bias.test.ts (assertion failure)
  - [ ] Fix and re-enable test: "should provide more stable exposure values for larger grains" in test/kernel-sampling.test.ts (assertion failure)
  - [ ] Fix and re-enable test: "should demonstrate different results from point vs kernel sampling" in test/kernel-sampling.test.ts (assertion failure)
  - [ ] Fix and re-enable test: "should not show directional bias in sensitivity values" in test/grain-properties-directional-bias.test.ts (assertion failure)
- [ ] Write test of processImage with a testpattern with the left side fully white and the right side fully black. Use a low iso. The output image should be almost completely white on the left side and almost completely black on the right side
- [ ] Reenable these tests and make sure they pass
  - [ ] Reenable `test/grain-processor-integration.test.ts` > "should process gradient patterns correctly" and investigate why it outputs black.
  - [ ] Reenable `test/grain-processor-integration.test.ts` > "should process radial patterns correctly" and investigate why it outputs black.
  - [ ] Reenable `test/grain-processor-integration.test.ts` > "should produce different results for different film types" and investigate why it outputs black.
  - [ ] Reenable `test/iterative-vs-single-pass.test.ts` > "should demonstrate improved lightness preservation with iterative approach" and investigate why it outputs black.
  - [ ] Reenable `test/grain-physical-behavior.test.ts` > "should produce FEWER grains as ISO increases" and update the test to work with a smaller image to make it faster.
- [ ] Remove any constants from constants.ts that are not used anywhere or are only used in tests
- [ ] Move any constant in constants.ts that are only used a single place to that place and remove it from constants.ts
- [ ] Enable each test below one by one. Check if it passes. If not, determine if the code or the test is wrong (probably the test). If the test is wrong, determine if it is worth it to update the test or better to just remove it.
  - [ ] `test/grain-processor.test.ts` > "should produce minimal changes to the original image at low ISO"
  - [ ] `test/grain-processor.test.ts` > "should have minimal grain effect at very low ISO (50)"
  - [ ] `test/grain-processor.test.ts` > "should preserve image structure at low ISO"
  - [ ] `test/grain-processor-integration.test.ts` > "should process checkerboard patterns correctly"
  - [ ] `test/grain-processor-integration.test.ts` > "should process gradient patterns correctly"
  - [ ] `test/grain-processor-integration.test.ts` > "should process radial patterns correctly"
  - [ ] `test/grain-processor-integration.test.ts` > "should maintain reasonable processing times"
  - [ ] `test/grain-processor-integration.test.ts` > "should produce minimal changes to the original image at low ISO"
  - [ ] `test/grain-processor-integration.test.ts` > "should have minimal grain effect at very low ISO (50)"
  - [ ] `test/grain-processor-integration.test.ts` > "should preserve image structure at low ISO"
  - [ ] `test/grain-processor-integration.test.ts` > "should produce different results for different film types"
  - [ ] `test/grain-physical-behavior.test.ts` > "should produce FEWER grains as ISO increases"
  - [ ] `test/exposure-lightness-preservation.test.ts` > "should preserve overall lightness for middle gray (18% gray)"
  - [ ] `test/exposure-lightness-preservation.test.ts` > "should preserve overall lightness for various gray levels"
  - [ ] `test/exposure-lightness-preservation.test.ts` > "should preserve overall lightness for black and white extremes"
  - [ ] `test/iterative-vs-single-pass.test.ts` > "should demonstrate improved lightness preservation with iterative approach"
  - [ ] `test/grain-two-phase-verification.test.ts` > "Performance Characteristics" (describe.skip)
- [ ] Create a page like public/grain-debug.html that replicates the testpatterns from grain-processor-integration.test.ts
- [ ] Update the grain generation logic to do a full 3d emulsion simulation. Or perhaps just increase the size of grains so that they violate the poisson min distance sometimes so they overlap?
  - In real film grains are suspended at multiple depths, and can overlap.
  - In the current implementation we don't support overlapping.
  - This should solve the issue with being unable to get proper coverage for high iso.
  - Could just take the current grain generation and just have multiple at different depths? Perhaps 2 or 3 layers?
  - If we decide to just increase the size of grains, will that complicate the spatial grid acceleration structure?
    ` - refer to GRAIN_OVERLAPPING.md for some notes on the issue
  - Update ALGORITHM_DESIGN.md with the new functionality
- [ ] Write a test that runs a smooth gradient through processImage. When lowpassing the resulting image the values should stay mostly the same as the input. That is, the algorithm should have a mostly linear lightness mapping.
- [ ] Add support for lower iso than 50
- [ ] Add slider to control how large the grains are relative to the image, as if to simulate the image being a cropped version of a small sections of the negative. (Or will this have the same effect as adjusting the iso?)
- [ ] When loading an image in the gui, adjust the zoom level to show the entire image.
- [ ] Add support for scrolling/sliding the image in the gui. Both the unprocessed and processed images should scroll the same.
- [ ] Remove the explanatory text in the gui at the bottom.
- [ ] Remove the advanced section in the gui.
- [ ] Remove the grain center debug drawing functionality.
- [ ] Enable all skipped tests again. If they fail check if they are outdated and should be removed. If they are still applicable determine if the code or the test is wrong.
- [ ] Go through the testcases and make sure they are all enabled and makes sense
- [ ] Optimize the algorithm
- [ ] Clean up unused files and debug utils such as `public/grain-test.html`
- [ ] Clean up old agent-generated analysis and summary md files.
- [ ] Update dependencies.
- [ ] **Implement grain bridging and clustering effects**: Add simulation of grains connecting during development through clustering algorithms. This creates more realistic grain patterns that match actual film behavior.
- [ ] **Add edge effects near high-contrast boundaries**: Implement grain density changes near high-contrast image boundaries to simulate developer depletion and chemical diffusion effects.
- [ ] Is it possible to parallelize the algorithm? Or move parts of it to the gpu using webgpu?
- [ ] Look for TODO comments in the code, and list them as subitems here.
- [ ] Go through the repo and clean up any unused files
- [ ] Go through the code looking for repeating patterns and refactor them into shared code if it makes sense.
- [ ] The html files in public shouldn't be included in the production build
- [ ] Go through the code and clean up any comments left by a coding agent to indicate what it has changed. Comments should typically describe "why" not "what. And while comments describing changes is useful when iteracting with an agent we don't want that in the final code.
