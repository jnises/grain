- [x] grain-properties-directional-bias.test.ts has the code ```
  // Diagonal threshold variations should not be extreme
      expect(thresholdDiagonalBias.ratio).toBeLessThan(25.0);
    ```
    That doesn't sound right. Isn't 25 quite extreme?
    Fixed: Changed threshold from 25.0 to 3.0 to be consistent with other bias tests (which use 2.0-2.5). The actual measured ratio is ~2.02, so 25.0 was indeed extremely lenient and not providing meaningful validation.
- [x] Try reversing the pixel processing order in processPixelEffects to check if the stripes change behavior.
- [x] Add a section visualizing the output of calculateGrainExposures in grain-test.html
      Completed: Added grain exposure visualization panel to grain-debug.html that uses the actual GrainProcessor.calculateGrainExposures method. The visualization shows grains color-coded by their exposure values (black for no exposure, gray shades for low/medium exposure, white for high exposure) and displays statistics about exposure distribution.
- [x] Create a debug html page that shows the image that would be generated by the "should produce uniform output with uniform dense grid grains without anisotropic effects" test. call it grain-patterns.html and add it to the main page dev mode links
      Completed: Created `grain-patterns.html` that replicates the uniform grid grain test visualization. The page shows grain placement, processed output, uniformity analysis with histogram, and anisotropy testing with directional bias measurement. Added link to dev mode section in App.tsx.
- [x] Could the striped pattern be due to color channel interleaving? The stripes are angled at 4 to 1 in x and y axis.
      COMPLETED: Investigation shows color channel interleaving is NOT the cause of stripe patterns. RGB channels remain identical throughout processing (100% identical, max difference = 0). No 4:1 periodicity detected in horizontal/vertical patterns. The striped patterns are caused by other systematic issues in the grain processing algorithm that affect all channels equally. Investigation tools created: scripts/temp/investigate-stripe-pattern.ts and scripts/temp/debug-rgb-channels.ts
- [x] In GrainProcessor.processImage grayscaleImageData has four color channels. incomingImageLinear also has four color channels. Then that variable is treated as if it only has one color channel calculateGrainExposures.
  The image needs to be converted to a single color channel Float32Array.
  COMPLETED: Fixed the data format mismatch in the grain processing pipeline. Added `convertGrayscaleLinearToSingleChannel()` function to convert 4-channel grayscale linear data to single-channel Float32Array for more efficient memory usage (4x reduction). Updated `sampleGrainAreaExposure()` to handle both single-channel and 4-channel data formats. Updated `estimateLightnessBySampling()` to work with single-channel data. All existing tests pass, confirming backward compatibility while achieving the memory efficiency improvement.
- [x] Make a testcase that loads gray.png and runs that through GrainProcessor.processImage. ensure that the output does not have directional patterns
      COMPLETED: Added comprehensive test in `grain-processor-integration.test.ts` that loads gray.png, processes it with GrainProcessor at ISO 100, and analyzes the output for directional patterns. Test includes directional bias analysis and diagonal stripe pattern detection. **RESULT: DIRECTIONAL PATTERNS DETECTED** - anisotropy ratio 1.32 (> 1.2), visual inspection shows diagonal stripes (1 pixel up per 4 pixels right, ~8 stripes total). Test saves processed image as output.png for visual inspection. This confirms there IS a systematic directional bias issue in the grain processing algorithm that needs investigation.
- [ ] reenable and fix these tests:
  - [ ] Fix and re-enable test: "should generate consistent grain properties" in test/grain-compositing.test.ts (timeout issue)
  - [ ] Fix and re-enable test: "should generate minimum viable grain count" in test/grain-distribution.test.ts (timeout issue)
  - [ ] Fix and re-enable test: "should distribute Poisson samples across entire image area" in test/grain-distribution.test.ts (assertion failure)
  - [ ] Fix and re-enable test: "should produce GREATER total grain coverage area as ISO increases" in test/grain-physical-behavior.test.ts (timeout issue)
  - [ ] Fix and re-enable test: "should handle very low ISO values (25-50) correctly" in test/grain-physical-behavior.test.ts (timeout issue)
  - [ ] Fix and re-enable test: "should not show correlated directional patterns between sensitivity and threshold" in test/grain-properties-directional-bias.test.ts (assertion failure)
  - [ ] Fix and re-enable test: "should provide more stable exposure values for larger grains" in test/kernel-sampling.test.ts (assertion failure)
  - [ ] Fix and re-enable test: "should demonstrate different results from point vs kernel sampling" in test/kernel-sampling.test.ts (assertion failure)
  - [ ] Fix and re-enable test: "should not show directional bias in sensitivity values" in test/grain-properties-directional-bias.test.ts (assertion failure)
- [ ] Examine why the algorithm introduces striped patterns. Look at gray.png grain-processed-image.png
  - [x] Create a visual analysis tool to examine stripe patterns in processed images
  - [x] Investigate Poisson disk sampling for directional bias in grain placement
    - Found critical issues: density ratio >1.0 causes algorithm failure and safety breaks
    - Performance problems at ISO 400+ (density ratio 1.465) and ISO 800+ (2.930)
    - Base grain size clamping at 0.5 for low ISO removes variation
    - Very small cell sizes (0.42) create oversized grids with 222k+ cells
    - Large excluded border area (60%) may create center-heavy distribution
    - Analysis tools created: src/debug/poisson-bias-analysis.ts and scripts/temp/analyze-poisson-issues.ts
  - [ ] Analyze spatial processing algorithms for anisotropic effects
  - [ ] Test grain application methods for systematic pixel processing artifacts
  - [ ] Compare stripe patterns across different ISO levels and film types
  - [ ] Document findings and propose algorithmic fixes
- [ ] Write test of processImage with a testpattern with the left side fully white and the right side fully black. Use a low iso. The output image should be almost completely white on the left side and almost completely black on the right side
- [ ] Reenable these tests and make sure they pass
  - [ ] Reenable `test/grain-processor-integration.test.ts` > "should process gradient patterns correctly" and investigate why it outputs black.
  - [ ] Reenable `test/grain-processor-integration.test.ts` > "should process radial patterns correctly" and investigate why it outputs black.
  - [ ] Reenable `test/grain-processor-integration.test.ts` > "should produce different results for different film types" and investigate why it outputs black.
  - [ ] Reenable `test/iterative-vs-single-pass.test.ts` > "should demonstrate improved lightness preservation with iterative approach" and investigate why it outputs black.
  - [ ] Reenable `test/grain-physical-behavior.test.ts` > "should produce FEWER grains as ISO increases" and update the test to work with a smaller image to make it faster.
- [ ] Remove any constants from constants.ts that are not used anywhere or are only used in tests
- [ ] Move any constant in constants.ts that are only used a single place to that place and remove it from constants.ts
- [ ] Enable each test below one by one. Check if it passes. If not, determine if the code or the test is wrong (probably the test). If the test is wrong, determine if it is worth it to update the test or better to just remove it.
  - [ ] `test/grain-processor.test.ts` > "should produce minimal changes to the original image at low ISO"
  - [ ] `test/grain-processor.test.ts` > "should have minimal grain effect at very low ISO (50)"
  - [ ] `test/grain-processor.test.ts` > "should preserve image structure at low ISO"
  - [ ] `test/grain-processor-integration.test.ts` > "should process checkerboard patterns correctly"
  - [ ] `test/grain-processor-integration.test.ts` > "should process gradient patterns correctly"
  - [ ] `test/grain-processor-integration.test.ts` > "should process radial patterns correctly"
  - [ ] `test/grain-processor-integration.test.ts` > "should maintain reasonable processing times"
  - [ ] `test/grain-processor-integration.test.ts` > "should produce minimal changes to the original image at low ISO"
  - [ ] `test/grain-processor-integration.test.ts` > "should have minimal grain effect at very low ISO (50)"
  - [ ] `test/grain-processor-integration.test.ts` > "should preserve image structure at low ISO"
  - [ ] `test/grain-processor-integration.test.ts` > "should produce different results for different film types"
  - [ ] `test/grain-physical-behavior.test.ts` > "should produce FEWER grains as ISO increases"
  - [ ] `test/exposure-lightness-preservation.test.ts` > "should preserve overall lightness for middle gray (18% gray)"
  - [ ] `test/exposure-lightness-preservation.test.ts` > "should preserve overall lightness for various gray levels"
  - [ ] `test/exposure-lightness-preservation.test.ts` > "should preserve overall lightness for black and white extremes"
  - [ ] `test/iterative-vs-single-pass.test.ts` > "should demonstrate improved lightness preservation with iterative approach"
  - [ ] `test/grain-two-phase-verification.test.ts` > "Performance Characteristics" (describe.skip)
- [ ] Create a page like public/grain-debug.html that replicates the testpatterns from grain-processor-integration.test.ts
- [ ] Update the grain generation logic to do a full 3d emulsion simulation.
  - In real film grains are suspended at multiple depths, and can overlap.
  - In the current implementation we don't support overlapping.
  - Could just take the current grain generation and just have multiple at different depths?
  - refer to GRAIN_OVERLAPPING.md for some notes on the issue
  - Update ALGORITHM_DESIGN.md with the new functionality
- [ ] Refactor functions like processPixelEffects to instead of iterating over pixels and using the spatial lookup grid it should iterate over grains and "render" those to the output image. Make sure it actually improves performance
- [ ] Add support for lower iso than 50
- [ ] Make sure the tests in grain-processor-integration.test.ts are not too lenient
- [ ] Add slider to control how large the grains are relative to the image, as if to simulate the image being a cropped version of a small sections of the negative. (Or will this have the same effect as adjusting the iso?)
- [ ] Do the film type settings refer to common industry standard settings? Or do they just result in some made up parameters? If made up, convert them to use some non-brand names instead. Or expose the underlying parameters?
- [ ] In the gui make the unprocessed image also show as grayscale. Apply the same rgb to grayscale operation as in the grain processing pipeline.
- [ ] Enable all skipped tests again. If they fail check if they are outdated and should be removed. If they are still applicable determine if the code or the test is wrong.
- [ ] Go through the testcases and make sure they are all enabled and makes sense
- [ ] Optimize the algorithm
- [ ] Clean up unused files and debug utils such as `public/grain-test.html`
- [ ] Clean up old agent-generated analysis and summary md files.
- [ ] Update dependencies.
- [ ] **Implement grain bridging and clustering effects**: Add simulation of grains connecting during development through clustering algorithms. This creates more realistic grain patterns that match actual film behavior.
- [ ] **Add edge effects near high-contrast boundaries**: Implement grain density changes near high-contrast image boundaries to simulate developer depletion and chemical diffusion effects.
- [ ] Is it possible to parallelize the algorithm? Or move parts of it to the gpu using webgpu?
- [ ] Look for TODO comments in the code, and list them as subitems here.
- [ ] Go through the repo and clean up any unused files
- [ ] Go through the code looking for repeating patterns and refactor them into shared code if it makes sense.
- [ ] The html files in public shouldn't be included in the production build
- [ ] Go through the code and clean up any comments left by a coding agent to indicate what it has changed. Comments should typically describe "why" not "what. And while comments describing changes is useful when iteracting with an agent we don't want that in the final code.
