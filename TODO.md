- [x] Remove hard to implement features of `ALGORITHM_DESIGN.md` such as parallax.
- [x] Check to make sure the `Compositing Multiple Grain Layers` section of `ALGORITHM_DESIGN.md` makes sense.
- [x] Remove the legacy algorithm
- [x] Go through the code and make sure it follows the instructions in `copilot-instructions.md`
- [x] Add instruction for agent to assert any assumption it makes.
- [x] Create custom assert function what does narrowing and such.
- [x] Go through the code and make sure assertions are added where it makes sense.
- [x] Ask why all the custom assertion functions are needed.
- [x] The algorithm is much slower when using `multiple grain layers` feature. Figure out why that is. **Fixed**: The issue was O(nÂ²) complexity in grain layer processing. Each pixel was doing `layer.grains.filter(grain => nearbyGrains.includes(grain))` which searched through all grains for each layer. Optimized by creating a grain-to-layer map for O(1) layer lookup instead. **Benchmarked**: Added comprehensive performance tests showing multiple layers now perform 1.2-1.6x faster than single layer mode, confirming the optimization works.
- [x] Add debug page that can visualize separate parts of the algorithm, such as raw grains before they are combined with the image. This page should only be available in dev mode. **Implemented**: Created `/public/grain-debug.html` with comprehensive algorithm visualization including raw Poisson/fallback grain points, multiple layer visualization, size distribution analysis, and spatial grid visualization. Added development-only link in main app header that only appears when `import.meta.env.DEV` is true.
- [ ] Go through `ALGORITHM_DESIGN.md` and compare against the current implementation. Describe what has been implemented and what hasn't any why.
- [ ] Add slider to control how large the grains are relative to the image, as if to simulate the image being a cropped version of a small sections of the negative. (Or will this have the same effect as adjusting the iso?)
- [ ] Add tests that applies the entire algorithm to some test patterns and make sure the result makes sense.
- [ ] Create a separate assert util for slow checks that is only run when in dev mode.
- [ ] Update agent instructions on how to use the asserts.
- [ ] Update hot code to use the dev assert.
- [ ] Optimize the algorithm
- [ ] Clean up unused files and debug utils such as `public/grain-test.html`
- [ ] Clean up old agent-generated analysis and summary md files.
- [ ] Update dependencies.
- [ ] Is it possible to parallelize the algorithm? Or move parts of it to the gpu using webgpu?
