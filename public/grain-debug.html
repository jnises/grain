<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grain Algorithm Debug Visualizer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .dev-only {
            border: 2px solid #ff6b35;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #2a1a1a;
            border-radius: 8px;
        }
        
        .dev-only h2 {
            color: #ff6b35;
            margin-top: 0;
        }
        
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #2a2a2a;
            border-radius: 5px;
        }
        
        .controls label {
            display: inline-block;
            width: 140px;
            margin-right: 10px;
            font-weight: bold;
        }
        
        .controls input, .controls select {
            margin: 5px 10px 5px 0;
            padding: 4px 8px;
            background-color: #3a3a3a;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 3px;
        }
        
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .visualization-panel {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #444;
        }
        
        .visualization-panel h3 {
            margin-top: 0;
            color: #4CAF50;
            border-bottom: 1px solid #444;
            padding-bottom: 8px;
        }
        
        canvas {
            border: 1px solid #555;
            background-color: #000;
            margin: 10px 0;
            display: block;
            max-width: 100%;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        .layer-controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .layer-button {
            background-color: #666;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .layer-button.active {
            background-color: #4CAF50;
        }
        
        .stats {
            background-color: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .color-legend {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .color-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .color-box {
            width: 12px;
            height: 12px;
            border: 1px solid #666;
        }
        
        .warning {
            background-color: #ff4444;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="dev-only">
        <h2>üîß Development Debug Page</h2>
        <p>This page visualizes internal components of the grain algorithm and is only available in development mode.</p>
    </div>

    <h1>Grain Algorithm Debug Visualizer</h1>
    
    <div class="controls">
        <div>
            <label>Canvas Width:</label>
            <input type="number" id="width" value="400" min="100" max="800">
            
            <label>Canvas Height:</label>
            <input type="number" id="height" value="300" min="100" max="600">
            
            <label>ISO:</label>
            <input type="number" id="iso" value="400" min="100" max="3200">
        </div>
        <div>
            <label>Film Type:</label>
            <select id="filmType">
                <option value="kodak">Kodak</option>
                <option value="fuji">Fuji</option>
                <option value="ilford">Ilford</option>
            </select>
            
            <label>Grain Intensity:</label>
            <input type="range" id="grainIntensity" min="0" max="2" step="0.1" value="1.0">
            <span id="intensityValue">1.0</span>
            
            <label>Multiple Layers:</label>
            <input type="checkbox" id="useMultipleLayers" checked>
        </div>
        <div>
            <button onclick="generateDebugVisualization()">Generate Visualization</button>
            <button onclick="clearAllCanvases()">Clear All</button>
        </div>
    </div>

    <div class="visualization-grid">
        <!-- Raw Grain Points -->
        <div class="visualization-panel">
            <h3>Raw Grain Points</h3>
            <canvas id="rawGrainsCanvas" width="400" height="300"></canvas>
            <div class="color-legend">
                <div class="color-item">
                    <div class="color-box" style="background-color: #00ff00;"></div>
                    <span>Poisson Points</span>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background-color: #ff6666;"></div>
                    <span>Fallback Points</span>
                </div>
            </div>
            <div class="stats" id="rawGrainsStats">Click "Generate Visualization" to see raw grain distribution...</div>
        </div>

        <!-- Grain Layers -->
        <div class="visualization-panel">
            <h3>Grain Layers</h3>
            <div class="layer-controls" id="layerControls">
                <button class="layer-button active" onclick="showLayer('all')">All Layers</button>
                <button class="layer-button" onclick="showLayer('primary')">Primary</button>
                <button class="layer-button" onclick="showLayer('secondary')">Secondary</button>
                <button class="layer-button" onclick="showLayer('micro')">Micro</button>
            </div>
            <canvas id="layersCanvas" width="400" height="300"></canvas>
            <div class="color-legend">
                <div class="color-item">
                    <div class="color-box" style="background-color: #ff4444;"></div>
                    <span>Primary Layer</span>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background-color: #44ff44;"></div>
                    <span>Secondary Layer</span>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background-color: #4444ff;"></div>
                    <span>Micro Layer</span>
                </div>
            </div>
            <div class="stats" id="layersStats">Click "Generate Visualization" to see layer breakdown...</div>
        </div>

        <!-- Grain Sizes -->
        <div class="visualization-panel">
            <h3>Grain Size Distribution</h3>
            <canvas id="sizesCanvas" width="400" height="300"></canvas>
            <div class="color-legend">
                <div class="color-item">
                    <div class="color-box" style="background-color: #ffff00;"></div>
                    <span>Large Grains</span>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background-color: #ff8800;"></div>
                    <span>Medium Grains</span>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background-color: #ff4400;"></div>
                    <span>Small Grains</span>
                </div>
            </div>
            <div class="stats" id="sizesStats">Click "Generate Visualization" to see size distribution...</div>
        </div>

        <!-- Spatial Grid -->
        <div class="visualization-panel">
            <h3>Spatial Acceleration Grid</h3>
            <canvas id="gridCanvas" width="400" height="300"></canvas>
            <div class="color-legend">
                <div class="color-item">
                    <div class="color-box" style="background-color: #333333;"></div>
                    <span>Grid Lines</span>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background-color: #666666;"></div>
                    <span>Cell Boundaries</span>
                </div>
                <div class="color-item">
                    <div class="color-box" style="background-color: #ffffff;"></div>
                    <span>Grains</span>
                </div>
            </div>
            <div class="stats" id="gridStats">Click "Generate Visualization" to see spatial grid...</div>
        </div>
    </div>

    <div id="devModeWarning" class="warning" style="display: none;">
        ‚ö†Ô∏è This debug page requires development mode. Build the project in production mode to hide this page.
    </div>

    <script type="module">
        // Check if we're in development mode
        const isDevelopment = import.meta.env?.DEV !== false; // Default to true for this debug page
        
        if (!isDevelopment) {
            document.getElementById('devModeWarning').style.display = 'block';
            document.body.style.opacity = '0.5';
        }

        // Import the actual GrainGenerator class to avoid code duplication
        import { GrainGenerator } from '../src/grain-generator.js';
        
        console.log('GrainGenerator imported for debug visualization:', GrainGenerator);
        
        // Global state for visualization
        let currentGrainStructure = null;
        let currentLayers = null;
        let currentRawGrains = null;
        let currentSettings = null;

        // Update intensity display
        document.getElementById('grainIntensity').addEventListener('input', function() {
            document.getElementById('intensityValue').textContent = this.value;
        });

        // Grain debug visualizer that uses the production GrainGenerator
        class GrainDebugVisualizer {
            constructor(width, height, settings) {
                this.width = width;
                this.height = height;
                this.settings = settings;
                this.grainGenerator = new GrainGenerator(width, height, settings);
            }
            
            generateRawGrains() {
                const params = this.grainGenerator.calculateGrainParameters();
                
                console.log('=== Raw Grain Generation ===');
                console.log(`Image: ${this.width}x${this.height}`);
                console.log(`ISO: ${this.settings.iso}`);
                console.log(`Base size: ${params.baseGrainSize.toFixed(3)}`);
                console.log(`Density: ${params.grainDensity}`);
                console.log(`Min distance: ${params.minDistance.toFixed(3)}`);
                
                const poissonPoints = this.grainGenerator.generatePoissonDiskSampling(params.minDistance, params.grainDensity);
                
                let fallbackPoints = [];
                let finalPoints = poissonPoints;
                
                if (poissonPoints.length < params.grainDensity * 0.5) {
                    console.log(`Using fallback: ${poissonPoints.length} < ${params.grainDensity * 0.5}`);
                    finalPoints = this.grainGenerator.generateFallbackGrains(poissonPoints, params.grainDensity);
                    fallbackPoints = finalPoints.slice(poissonPoints.length);
                }
                
                return {
                    poissonPoints,
                    fallbackPoints,
                    finalPoints,
                    params
                };
            }
            
            generateLayerStructure() {
                if (this.settings.useMultipleLayers) {
                    return this.grainGenerator.generateMultipleGrainLayers();
                } else {
                    const grains = this.grainGenerator.generateGrainStructure();
                    return [{
                        layerType: 'single',
                        grains: grains,
                        baseSize: 1.0,
                        density: grains.length,
                        intensityMultiplier: 1.0
                    }];
                }
            }
        }

        function log(message, statsElementId) {
            const element = document.getElementById(statsElementId);
            if (element) {
                element.textContent += message + '\n';
                element.scrollTop = element.scrollHeight;
            }
            console.log(message);
        }

        function clearStats(statsElementId) {
            const element = document.getElementById(statsElementId);
            if (element) {
                element.textContent = '';
            }
        }

        function drawPoints(canvasId, points, color = '#ffffff', size = 1) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = color;
            for (const point of points) {
                ctx.fillRect(Math.floor(point.x), Math.floor(point.y), size, size);
            }
        }

        function drawGrains(canvasId, grains, color = '#ffffff') {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = color;
            for (const grain of grains) {
                const size = Math.max(1, Math.floor(grain.size));
                ctx.fillRect(
                    Math.floor(grain.x - size/2), 
                    Math.floor(grain.y - size/2), 
                    size, 
                    size
                );
            }
        }

        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function updateCanvasSize(canvasId, width, height) {
            const canvas = document.getElementById(canvasId);
            canvas.width = width;
            canvas.height = height;
        }

        function visualizeRawGrains(grainData) {
            clearStats('rawGrainsStats');
            clearCanvas('rawGrainsCanvas');
            
            // Draw Poisson points in green
            drawPoints('rawGrainsCanvas', grainData.poissonPoints, '#00ff00', 2);
            
            // Draw fallback points in red
            if (grainData.fallbackPoints.length > 0) {
                drawPoints('rawGrainsCanvas', grainData.fallbackPoints, '#ff6666', 2);
            }
            
            // Log statistics
            log(`Poisson points: ${grainData.poissonPoints.length}`, 'rawGrainsStats');
            log(`Fallback points: ${grainData.fallbackPoints.length}`, 'rawGrainsStats');
            log(`Total points: ${grainData.finalPoints.length}`, 'rawGrainsStats');
            log(`Target density: ${grainData.params.grainDensity}`, 'rawGrainsStats');
            log(`Achieved density: ${(grainData.finalPoints.length / (currentSettings.width * currentSettings.height) * 1000).toFixed(2)} per 1000px`, 'rawGrainsStats');
            log(`Base grain size: ${grainData.params.baseGrainSize.toFixed(3)}`, 'rawGrainsStats');
            log(`Min distance: ${grainData.params.minDistance.toFixed(3)}`, 'rawGrainsStats');
        }

        function visualizeLayers(layers, activeLayer = 'all') {
            clearStats('layersStats');
            clearCanvas('layersCanvas');
            
            const layerColors = {
                'primary': '#ff4444',
                'secondary': '#44ff44', 
                'micro': '#4444ff',
                'single': '#ffffff'
            };
            
            let totalGrains = 0;
            
            for (const layer of layers) {
                if (activeLayer === 'all' || activeLayer === layer.layerType) {
                    const color = layerColors[layer.layerType] || '#ffffff';
                    drawGrains('layersCanvas', layer.grains, color);
                }
                
                totalGrains += layer.grains.length;
                log(`${layer.layerType}: ${layer.grains.length} grains, base size: ${layer.baseSize.toFixed(2)}`, 'layersStats');
            }
            
            log(`Total grains: ${totalGrains}`, 'layersStats');
            log(`Showing: ${activeLayer}`, 'layersStats');
        }

        function visualizeSizeDistribution(layers) {
            clearStats('sizesStats');
            clearCanvas('sizesCanvas');
            
            const allGrains = layers.flatMap(layer => layer.grains);
            const sizes = allGrains.map(g => g.size);
            const minSize = Math.min(...sizes);
            const maxSize = Math.max(...sizes);
            const sizeRange = maxSize - minSize;
            
            // Categorize grains by size
            const smallThreshold = minSize + sizeRange * 0.33;
            const mediumThreshold = minSize + sizeRange * 0.66;
            
            const smallGrains = allGrains.filter(g => g.size <= smallThreshold);
            const mediumGrains = allGrains.filter(g => g.size > smallThreshold && g.size <= mediumThreshold);
            const largeGrains = allGrains.filter(g => g.size > mediumThreshold);
            
            // Draw with different colors
            drawGrains('sizesCanvas', smallGrains, '#ff4400');
            drawGrains('sizesCanvas', mediumGrains, '#ff8800');
            drawGrains('sizesCanvas', largeGrains, '#ffff00');
            
            // Log statistics
            log(`Size range: ${minSize.toFixed(2)} - ${maxSize.toFixed(2)}`, 'sizesStats');
            log(`Small grains (<${smallThreshold.toFixed(2)}): ${smallGrains.length}`, 'sizesStats');
            log(`Medium grains: ${mediumGrains.length}`, 'sizesStats');
            log(`Large grains (>${mediumThreshold.toFixed(2)}): ${largeGrains.length}`, 'sizesStats');
            log(`Average size: ${(sizes.reduce((a, b) => a + b, 0) / sizes.length).toFixed(2)}`, 'sizesStats');
        }

        function visualizeSpatialGrid(layers) {
            clearStats('gridStats');
            clearCanvas('gridCanvas');
            
            const canvas = document.getElementById('gridCanvas');
            const ctx = canvas.getContext('2d');
            
            const allGrains = layers.flatMap(layer => layer.grains);
            const maxGrainSize = Math.max(...allGrains.map(g => g.size));
            const gridSize = Math.max(8, Math.floor(maxGrainSize * 2));
            
            const gridCols = Math.ceil(canvas.width / gridSize);
            const gridRows = Math.ceil(canvas.height / gridSize);
            
            // Draw grid lines
            ctx.strokeStyle = '#333333';
            ctx.lineWidth = 1;
            
            for (let x = 0; x <= gridCols; x++) {
                ctx.beginPath();
                ctx.moveTo(x * gridSize, 0);
                ctx.lineTo(x * gridSize, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y <= gridRows; y++) {
                ctx.beginPath();
                ctx.moveTo(0, y * gridSize);
                ctx.lineTo(canvas.width, y * gridSize);
                ctx.stroke();
            }
            
            // Draw cell boundaries for cells with grains
            ctx.strokeStyle = '#666666';
            ctx.lineWidth = 2;
            
            const cellCounts = new Map();
            
            for (const grain of allGrains) {
                const cellX = Math.floor(grain.x / gridSize);
                const cellY = Math.floor(grain.y / gridSize);
                const cellKey = `${cellX},${cellY}`;
                cellCounts.set(cellKey, (cellCounts.get(cellKey) || 0) + 1);
            }
            
            for (const [cellKey, count] of cellCounts.entries()) {
                const [cellX, cellY] = cellKey.split(',').map(Number);
                const x = cellX * gridSize;
                const y = cellY * gridSize;
                
                ctx.strokeRect(x, y, gridSize, gridSize);
            }
            
            // Draw grains as white dots
            drawGrains('gridCanvas', allGrains, '#ffffff');
            
            // Log statistics
            log(`Grid size: ${gridSize}px`, 'gridStats');
            log(`Grid dimensions: ${gridCols} x ${gridRows}`, 'gridStats');
            log(`Total cells: ${gridCols * gridRows}`, 'gridStats');
            log(`Occupied cells: ${cellCounts.size}`, 'gridStats');
            log(`Occupancy rate: ${(cellCounts.size / (gridCols * gridRows) * 100).toFixed(1)}%`, 'gridStats');
            log(`Max grains in cell: ${Math.max(...cellCounts.values())}`, 'gridStats');
            log(`Avg grains per occupied cell: ${(allGrains.length / cellCounts.size).toFixed(1)}`, 'gridStats');
        }

        window.generateDebugVisualization = function() {
            const width = parseInt(document.getElementById('width').value);
            const height = parseInt(document.getElementById('height').value);
            const iso = parseInt(document.getElementById('iso').value);
            const filmType = document.getElementById('filmType').value;
            const grainIntensity = parseFloat(document.getElementById('grainIntensity').value);
            const useMultipleLayers = document.getElementById('useMultipleLayers').checked;
            
            currentSettings = {
                width,
                height,
                iso,
                filmType,
                grainIntensity,
                upscaleFactor: 1.0,
                useMultipleLayers
            };
            
            // Update all canvas sizes
            updateCanvasSize('rawGrainsCanvas', width, height);
            updateCanvasSize('layersCanvas', width, height);
            updateCanvasSize('sizesCanvas', width, height);
            updateCanvasSize('gridCanvas', width, height);
            
            clearAllCanvases();
            
            const visualizer = new GrainDebugVisualizer(width, height, currentSettings);
            
            console.log('=== Debug Visualization Generation ===');
            console.log('Settings:', currentSettings);
            
            // Generate raw grains
            currentRawGrains = visualizer.generateRawGrains();
            visualizeRawGrains(currentRawGrains);
            
            // Generate layers
            currentLayers = visualizer.generateLayerStructure();
            visualizeLayers(currentLayers);
            
            // Show size distribution
            visualizeSizeDistribution(currentLayers);
            
            // Show spatial grid
            visualizeSpatialGrid(currentLayers);
        };

        window.showLayer = function(layerType) {
            if (!currentLayers) return;
            
            // Update button states
            document.querySelectorAll('.layer-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            visualizeLayers(currentLayers, layerType);
        };

        window.clearAllCanvases = function() {
            ['rawGrainsCanvas', 'layersCanvas', 'sizesCanvas', 'gridCanvas'].forEach(clearCanvas);
            ['rawGrainsStats', 'layersStats', 'sizesStats', 'gridStats'].forEach(clearStats);
        };

        // Generate initial visualization on load
        window.onload = function() {
            try {
                console.log('Debug page loaded, testing GrainGenerator...');
                window.generateDebugVisualization();
            } catch (error) {
                console.error('Error during debug initialization:', error);
            }
        };
    </script>
</body>
</html>
